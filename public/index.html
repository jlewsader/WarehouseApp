<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warehouse System</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>

<header>
  <h1>Warehouse System</h1>
</header>

<main id="app">
  <section class="search-panel">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Search</p>
        <h2>Find inventory on the map</h2>
      </div>
    </div>

    <div class="search-grid">
      <label>
        Brand
        <input type="text" v-model="search.brand" placeholder="e.g. Keystone" />
      </label>
      <label>
        Product
        <input type="text" v-model="search.product" placeholder="Product code" />
      </label>
      <label>
        Seed size
        <input type="text" v-model="search.seed_size" placeholder="e.g. MF" />
      </label>
      <label>
        Package
        <input type="text" v-model="search.package_type" placeholder="e.g. SP50" />
      </label>
      <label>
        Lot
        <input type="text" v-model="search.lot" placeholder="Lot number" />
      </label>
    </div>

    <div class="barcode-row">
      <label class="barcode-field">
        Barcode
        <input
          type="text"
          v-model="search.barcode"
          placeholder="Scan or type GTIN"
          @keypress.enter.prevent="prefillFromBarcode"
        />
      </label>
      <button @click="prefillFromBarcode">Parse barcode</button>
      <button @click="openCameraScanner('search')" class="camera-btn" title="Scan with camera">ðŸ“· Scan</button>
    </div>

    <div class="search-actions">
      <div class="action-buttons">
        <button @click="runSearch" :disabled="searching">{{ searching ? 'Searchingâ€¦' : 'Search' }}</button>
        <button type="button" class="ghost" @click="clearSearch" :disabled="searching">Clear</button>
      </div>
      <div class="search-messages">
        <span class="muted" v-if="searchMessage">{{ searchMessage }}</span>
        <span class="pill" v-if="searchResults.length">{{ searchResults.length }} match{{ searchResults.length === 1 ? '' : 'es' }}</span>
      </div>
    </div>

    <div v-if="searchResults.length" class="search-results">
      <article
        v-for="result in searchResults"
        :key="result.id"
        class="result-card"
        :class="{ 'unassigned': result.location_id === 9999 }"
      >
        <header>
          <strong>{{ result.brand }} {{ result.product_code }}</strong>
          <span class="pill" v-if="result.location_id === 9999">UNASSIGNED</span>
        </header>
        <p class="result-meta">
          Lot: {{ result.lot || 'N/A' }} â€¢ Size: {{ result.seed_size || 'N/A' }} â€¢ Package: {{ result.package_type || 'N/A' }}
        </p>
        <p class="result-meta">
          Location: {{ result.location_label }} ({{ result.zone }})
          <span v-if="isSearchHit(result.location_id) && result.location_id !== 9999"> â€” highlighted on map</span>
        </p>
      </article>
    </div>
  </section>

  <div class="map-layout">
    <section class="inbound-panel" id="inbound">
      <div class="section-heading">
        <div>
          <p class="eyebrow">Inbound</p>
          <h2>Unassigned inventory</h2>
        </div>
        <label class="sort-control">
          Sort by
          <select v-model="inboundSort">
            <option value="brand">Brand</option>
            <option value="product_code">Product Code</option>
            <option value="lot">Lot Number</option>
            <option value="newest">Newest First</option>
          </select>
        </label>
      </div>

      <div v-if="!inbound.length" class="info-box">
        <p>No inbound inventory waiting to be placed.</p>
      </div>

      <div class="info-box" style="margin-bottom: 16px;">
        <div class="barcode-row" style="margin-bottom: 8px;">
          <label class="barcode-field" style="flex:1;">
            Barcode (GTIN)
            <input
              type="text"
              v-model="scan.barcode"
              placeholder="Scan or type GTIN"
              @keypress.enter.prevent="lookupInboundBarcode"
            />
          </label>
          <div class="action-buttons">
            <button @click="lookupInboundBarcode">Lookup</button>
            <button @click="openCameraScanner('inbound')" class="camera-btn" title="Scan with camera">ðŸ“·</button>
            <button type="button" class="ghost" @click="resetScanState()">Clear</button>
          </div>
        </div>

        <div v-if="scan.view === 'message' || scan.view === 'idle'">
          <p class="muted">{{ scan.message }}</p>
        </div>

        <div v-else-if="scan.view === 'product-found'" class="result-card" style="margin-top: 8px;">
          <header>
            <strong>{{ scan.product.brand }} {{ scan.product.product_code }}</strong>
          </header>
          <p class="result-meta">
            Size: {{ scan.product.seed_size || 'N/A' }} â€¢ Package: {{ scan.product.package_type || 'N/A' }} â€¢ Units/Package: {{ scan.product.units_per_package || 1 }}
          </p>
          <label class="barcode-field" style="margin-top: 8px;">
            Lot
            <input type="text" v-model="scan.receivingLot" />
          </label>
          <label class="barcode-field" style="margin-top: 8px;">
            Quantity Received
            <input type="number" min="1" v-model.number="scan.receivingQty" />
          </label>
          <div class="action-buttons" style="margin-top: 10px;">
            <button @click="receiveInventoryFromScan">Receive</button>
            <button type="button" class="ghost" @click="resetScanState()">Cancel</button>
          </div>
        </div>

        <div v-else-if="scan.view === 'new-product'" class="result-card" style="margin-top: 8px;">
          <header>
            <strong>New Product</strong>
          </header>
          <p class="result-meta">Barcode: {{ scan.newProduct.barcode }}</p>

          <label class="barcode-field">
            Brand
            <select v-model="scan.newProduct.brand">
              <option value="">-- Select Brand --</option>
              <option v-for="b in scanOptions.brands" :key="b" :value="b">{{ b }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.brand === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.brandOther"
              placeholder="Type brand"
              style="margin-top:6px;"
            />
          </label>

          <label class="barcode-field">
            Product Code / Description
            <input type="text" v-model="scan.newProduct.product_code" />
          </label>

          <label class="barcode-field">
            Lot
            <input type="text" v-model="scan.newProduct.lot" />
          </label>

          <label class="barcode-field">
            Seed Size
            <select v-model="scan.newProduct.seed_size">
              <option value="">-- Select Size --</option>
              <option v-for="s in scanOptions.seedSizes" :key="s" :value="s">{{ s }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.seed_size === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.seed_size_other"
              placeholder="Type size"
              style="margin-top:6px;"
            />
          </label>

          <label class="barcode-field">
            Package Type
            <select v-model="scan.newProduct.package_type">
              <option value="">-- Select Package --</option>
              <option v-for="p in scanOptions.packageTypes" :key="p" :value="p">{{ p }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.package_type === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.package_type_other"
              placeholder="Type package"
              style="margin-top:6px;"
            />
          </label>

          <div class="action-buttons" style="margin-top: 10px;">
            <button @click="saveNewProduct">Save Product</button>
            <button type="button" class="ghost" @click="resetScanState()">Cancel</button>
          </div>
          <p class="muted" style="margin-top:6px;">Brand and product code are required.</p>
        </div>
      </div>

      <div v-else class="inbound-list">
        <article
          v-for="group in inboundGroups"
          :key="group.key"
          class="inbound-group"
        >
          <header class="group-header">
            <div>
              <div class="group-title">{{ group.product.brand }} {{ group.product.product_code }}</div>
              <div class="group-meta">
                Lot: {{ group.product.lot || 'N/A' }}
                â€¢ Size: {{ group.product.seed_size || 'N/A' }}
                â€¢ Package: {{ group.product.package_type || 'N/A' }}
              </div>
            </div>
            <div class="group-qty">
              <div class="qty">{{ group.items.length }}</div>
              <small>packages</small>
            </div>
          </header>

          <div class="group-items">
            <label
              v-for="item in group.items"
              :key="item.id"
              class="inbound-row"
              :class="{ selected: selectedInboundId === item.id }"
              @click="selectInboundItem(item)"
            >
              <input
                type="radio"
                name="inboundSelection"
                :value="item.id"
                v-model="selectedInboundId"
              />
              <div class="row-body">
                <div class="row-main">
                  <strong>{{ group.product.brand }} {{ group.product.product_code }}</strong>
                  <span class="pill">{{ item.units_per_package || 1 }} units</span>
                </div>
                <div class="row-sub">
                  Lot: {{ item.lot || group.product.lot || 'N/A' }} â€¢ Size: {{ item.seed_size || group.product.seed_size || 'N/A' }} â€¢ Package: {{ item.package_type || group.product.package_type || 'N/A' }} â€¢ Owner: {{ item.owner || 'N/A' }}
                </div>
              </div>
            </label>
          </div>
        </article>
      </div>
    </section>

    <section class="map-panel">
      <div class="map-actions">
        <div class="selection-summary">
          <p>
            <strong>Destination: </strong>
            <span v-if="selectedDestinationId">Location {{ selectedDestinationId }}</span>
            <span v-else class="muted">Choose an empty tier on the map.</span>
          </p>
          <p>
            <strong>Item to move: </strong>
            <span v-if="selectedMoveSummary">{{ selectedMoveSummary }}</span>
            <span v-else class="muted">Select inbound or click an occupied location.</span>
          </p>
        </div>
        <div class="action-buttons">
          <button type="button" class="ghost" @click="clearSelections">Clear selections</button>
          <button
            :disabled="!selectedMoveInventoryId || !selectedDestinationId"
            @click="confirmMove"
          >
            Move item here
          </button>
        </div>
      </div>

      <div class="section-heading">
        <div>
          <p class="eyebrow">Map</p>
          <h2>Warehouse layout</h2>
        </div>
      </div>

      <div class="zones-container" aria-label="Warehouse zones">
        <div v-for="zone in zones" :key="zone" class="zone-section">
          <div class="zone-header">
            <h3 class="zone-title">{{ zone }}</h3>
            <span class="zone-count">{{ zoneLocationCounts[zone] }} locations</span>
          </div>

          <div class="warehouse" :data-zone="zone">
            <div v-for="row in rowsByZone[zone]" :key="`${zone}-${row.row}`" class="warehouse-row">
              <div class="row-label">Row {{ row.row }}</div>

              <div class="row-cells">
                <div
                  v-for="cell in row.cells"
                  :key="`${zone}-${cell.row}-${cell.col}`"
                  class="stack"
                >
                  <!-- T -->
                  <div
                    class="tier"
                    v-if="cell.tiers.T"
                    :class="{
                      occupied: isOccupied(cell.tiers.T.id),
                      selected: selectedLocationId === cell.tiers.T.id,
                      destination: selectedDestinationId === cell.tiers.T.id,
                      source: selectedSourceLocationId === cell.tiers.T.id,
                      'search-hit': isSearchHit(cell.tiers.T.id)
                    }"
                    @click="onTierTap(cell.tiers.T)"
                  >
                    <template v-if="inventoryAt(cell.tiers.T.id)">
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.T.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.T.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.T.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.T.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                  <!-- M -->
                  <div
                    class="tier"
                    v-if="cell.tiers.M"
                    :class="{
                      occupied: isOccupied(cell.tiers.M.id),
                      selected: selectedLocationId === cell.tiers.M.id,
                      destination: selectedDestinationId === cell.tiers.M.id,
                      source: selectedSourceLocationId === cell.tiers.M.id,
                      'search-hit': isSearchHit(cell.tiers.M.id)
                    }"
                    @click="onTierTap(cell.tiers.M)"
                  >
                    <template v-if="inventoryAt(cell.tiers.M.id)">
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.M.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.M.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.M.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.M.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                  <!-- B -->
                  <div
                    class="tier"
                    v-if="cell.tiers.B"
                    :class="{
                      occupied: isOccupied(cell.tiers.B.id),
                      selected: selectedLocationId === cell.tiers.B.id,
                      destination: selectedDestinationId === cell.tiers.B.id,
                      source: selectedSourceLocationId === cell.tiers.B.id,
                      'search-hit': isSearchHit(cell.tiers.B.id)
                    }"
                    @click="onTierTap(cell.tiers.B)"
                  >
                    <template v-if="inventoryAt(cell.tiers.B.id)">
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.B.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.B.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.B.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.B.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

  </div>
</main>

<!-- Camera Scanner Modal -->
<div id="camera-scanner-modal" class="scanner-modal" style="display: none;">
  <div class="scanner-overlay" onclick="closeCameraScanner()"></div>
  <div class="scanner-container">
    <div class="scanner-header">
      <h3>Scan Barcode</h3>
      <button onclick="closeCameraScanner()" class="close-btn" aria-label="Close scanner">âœ•</button>
    </div>
    <div id="qr-reader" class="scanner-video"></div>
    <div class="scanner-footer">
      <p id="scanner-status" class="scanner-status">Position barcode within frame</p>
      <div class="scanner-buttons">
        <button onclick="switchToFileUpload()" class="secondary-btn">ðŸ“· Take Photo Instead</button>
        <button onclick="closeCameraScanner()" class="ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="/js/barcode-utils.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="/js/scanner.js"></script>
<script src="/js/map.js"></script>

</body>
</html>
