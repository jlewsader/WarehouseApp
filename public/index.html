<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warehouse System</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>

<main id="app">
<header>
  <h1>Warehouse System</h1>
  <div class="header-controls">
    <button @click="toggleSearch" class="header-btn" :class="{ active: showSearch }">üîç Search</button>
    <button @click="toggleInbound" class="header-btn" :class="{ active: showInbound }">üì¶ Inbound</button>
    <a href="/admin.html" class="admin-link">‚öôÔ∏è Admin</a>
  </div>
</header>

  <section class="search-panel" v-show="showSearch">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Search</p>
        <h2>Find inventory on the map</h2>
      </div>
    </div>

    <div class="search-grid">
      <label>
        Brand
        <input type="text" v-model="search.brand" placeholder="e.g. Keystone" />
      </label>
      <label>
        Product
        <input type="text" v-model="search.product" placeholder="Product code" />
      </label>
      <label>
        Seed size
        <input type="text" v-model="search.seed_size" placeholder="e.g. MF" />
      </label>
      <label>
        Package
        <input type="text" v-model="search.package_type" placeholder="e.g. SP50" />
      </label>
      <label>
        Lot
        <input type="text" v-model="search.lot" placeholder="Lot number" />
      </label>
    </div>

    <div class="barcode-row">
      <label class="barcode-field">
        Barcode
        <input
          type="text"
          v-model="search.barcode"
          placeholder="Scan or type GTIN"
          @keypress.enter.prevent="prefillFromBarcode"
        />
      </label>
      <button @click="prefillFromBarcode">Parse barcode</button>
      <button @click="openCameraScanner('search')" class="camera-btn" title="Scan with camera">üì∑ Scan</button>
    </div>

    <div class="search-actions">
      <div class="action-buttons">
        <button @click="runSearch" :disabled="searching">{{ searching ? 'Searching‚Ä¶' : 'Search' }}</button>
        <button type="button" class="ghost" @click="clearSearch" :disabled="searching">Clear</button>
      </div>
      <div class="search-messages">
        <span class="muted" v-if="searchMessage">{{ searchMessage }}</span>
        <span class="pill" v-if="searchResults.length">{{ searchResults.length }} match{{ searchResults.length === 1 ? '' : 'es' }}</span>
      </div>
    </div>

    <div v-if="searchResults.length" class="search-results">
      <article
        v-for="result in searchResults"
        :key="result.id"
        class="result-card"
        :class="{ 'unassigned': result.location_id === 9999 }"
      >
        <header>
          <strong>{{ result.brand }} {{ result.product_code }}</strong>
          <span class="pill" v-if="result.location_id === 9999">UNASSIGNED</span>
        </header>
        <p class="result-meta">
          Lot: {{ result.lot || 'N/A' }} ‚Ä¢ Size: {{ result.seed_size || 'N/A' }} ‚Ä¢ Package: {{ result.package_type || 'N/A' }}
        </p>
        <p class="result-meta">
          Location: {{ result.location_label }} ({{ result.zone }})
          <span v-if="isSearchHit(result.location_id) && result.location_id !== 9999"> ‚Äî highlighted on map</span>
        </p>
      </article>
    </div>
  </section>

  <div class="map-layout">
    <section class="inbound-panel" id="inbound" v-show="showInbound">
      <div class="section-heading">
        <div>
          <p class="eyebrow">Inbound</p>
          <h2>Unassigned inventory</h2>
        </div>
        <label class="sort-control">
          Sort by
          <select v-model="inboundSort">
            <option value="brand">Brand</option>
            <option value="product_code">Product Code</option>
            <option value="lot">Lot Number</option>
            <option value="newest">Newest First</option>
          </select>
        </label>
      </div>

      <div v-if="!inbound.length" class="info-box">
        <p>No inbound inventory waiting to be placed.</p>
      </div>

      <div class="info-box" style="margin-bottom: 16px;">
        <div class="barcode-row" style="margin-bottom: 8px;">
          <label class="barcode-field" style="flex:1;">
            Barcode (GTIN)
            <input
              type="text"
              v-model="scan.barcode"
              placeholder="Scan or type GTIN"
              @keypress.enter.prevent="lookupInboundBarcode"
            />
          </label>
          <div class="action-buttons">
            <button @click="lookupInboundBarcode">Lookup</button>
            <button @click="openCameraScanner('inbound')" class="camera-btn" title="Scan with camera">üì∑</button>
            <button type="button" class="ghost" @click="resetScanState()">Clear</button>
          </div>
        </div>

        <div v-if="scan.view === 'message' || scan.view === 'idle'">
          <p class="muted">{{ scan.message }}</p>
        </div>

        <div v-else-if="scan.view === 'product-found'" class="result-card" style="margin-top: 8px;">
          <header>
            <strong>{{ scan.product.brand }} {{ scan.product.product_code }}</strong>
          </header>
          <p class="result-meta">
            Size: {{ scan.product.seed_size || 'N/A' }} ‚Ä¢ Package: {{ scan.product.package_type || 'N/A' }} ‚Ä¢ Units/Package: {{ scan.product.units_per_package || 1 }}
          </p>
          <label class="barcode-field" style="margin-top: 8px;">
            Lot
            <input type="text" v-model="scan.receivingLot" />
          </label>
          <label class="barcode-field" style="margin-top: 8px;">
            Quantity Received
            <input type="number" min="1" v-model.number="scan.receivingQty" />
          </label>
          <div class="action-buttons" style="margin-top: 10px;">
            <button @click="receiveInventoryFromScan">Receive</button>
            <button type="button" class="ghost" @click="resetScanState()">Cancel</button>
          </div>
        </div>

        <div v-else-if="scan.view === 'new-product'" class="result-card" style="margin-top: 8px;">
          <header>
            <strong>New Product</strong>
          </header>
          <p class="result-meta">Barcode: {{ scan.newProduct.barcode }}</p>

          <label class="barcode-field">
            Brand
            <select v-model="scan.newProduct.brand">
              <option value="">-- Select Brand --</option>
              <option v-for="b in scanOptions.brands" :key="b" :value="b">{{ b }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.brand === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.brandOther"
              placeholder="Type brand"
              style="margin-top:6px;"
            />
          </label>

          <label class="barcode-field">
            Product Code / Description
            <input type="text" v-model="scan.newProduct.product_code" />
          </label>

          <label class="barcode-field">
            Lot
            <input type="text" v-model="scan.newProduct.lot" />
          </label>

          <label class="barcode-field">
            Seed Size
            <select v-model="scan.newProduct.seed_size">
              <option value="">-- Select Size --</option>
              <option v-for="s in scanOptions.seedSizes" :key="s" :value="s">{{ s }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.seed_size === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.seed_size_other"
              placeholder="Type size"
              style="margin-top:6px;"
            />
          </label>

          <label class="barcode-field">
            Package Type
            <select v-model="scan.newProduct.package_type">
              <option value="">-- Select Package --</option>
              <option v-for="p in scanOptions.packageTypes" :key="p" :value="p">{{ p }}</option>
              <option value="__OTHER__">Other...</option>
            </select>
            <input
              v-if="scan.newProduct.package_type === '__OTHER__'"
              type="text"
              v-model="scan.newProduct.package_type_other"
              placeholder="Type package"
              style="margin-top:6px;"
            />
          </label>

          <div class="action-buttons" style="margin-top: 10px;">
            <button @click="saveNewProduct">Save Product</button>
            <button type="button" class="ghost" @click="resetScanState()">Cancel</button>
          </div>
          <p class="muted" style="margin-top:6px;">Brand and product code are required.</p>
        </div>
      </div>

      <div v-else class="inbound-list">
        <article
          v-for="group in inboundGroups"
          :key="group.key"
          class="inbound-group"
        >
          <header class="group-header">
            <div>
              <div class="group-title">{{ group.product.brand }} {{ group.product.product_code }}</div>
              <div class="group-meta">
                Lot: {{ group.product.lot || 'N/A' }}
                ‚Ä¢ Size: {{ group.product.seed_size || 'N/A' }}
                ‚Ä¢ Package: {{ group.product.package_type || 'N/A' }}
              </div>
            </div>
            <div class="group-qty">
              <div class="qty">{{ group.items.length }}</div>
              <small>packages</small>
            </div>
          </header>

          <div class="group-items">
            <label
              v-for="item in group.items"
              :key="item.id"
              class="inbound-row"
              :class="{ 
                selected: selectedInboundId === item.id,
                checked: isInventorySelected(item.id)
              }"
            >
              <input
                v-if="multiSelectMode"
                type="checkbox"
                :checked="isInventorySelected(item.id)"
                @change="toggleInventorySelection(item.id)"
                class="inbound-checkbox"
              />
              <input
                v-else
                type="radio"
                name="inboundSelection"
                :value="item.id"
                v-model="selectedInboundId"
                @click="selectInboundItem(item)"
              />
              <div class="row-body">
                <div class="row-main">
                  <strong>{{ group.product.brand }} {{ group.product.product_code }}</strong>
                  <span class="pill">{{ item.units_per_package || 1 }} units</span>
                </div>
                <div class="row-sub">
                  Lot: {{ item.lot || group.product.lot || 'N/A' }} ‚Ä¢ Size: {{ item.seed_size || group.product.seed_size || 'N/A' }} ‚Ä¢ Package: {{ item.package_type || group.product.package_type || 'N/A' }} ‚Ä¢ Owner: {{ item.owner || 'N/A' }}
                </div>
              </div>
            </label>
          </div>
        </article>
      </div>
    </section>

    <section class="map-panel">
      <div class="section-heading">
        <div>
          <p class="eyebrow">Map</p>
          <h2>Warehouse layout</h2>
        </div>
      </div>

      <!-- Multi-Select Mode Controls -->
      <div class="mode-controls">
        <button 
          :class="{ active: multiSelectMode }" 
          @click="toggleMultiSelectMode"
          class="mode-btn"
        >
          {{ multiSelectMode ? '‚úì Multi-Select Active' : 'Enable Multi-Select' }}
        </button>
        <div v-if="hasAnyStagedItems" class="filter-controls">
          <label class="customer-filter">
            Filter by Customer:
            <select v-model="customerFilter">
              <option value="">All Items</option>
              <option value="__STAGED__">All Staged Items</option>
              <option v-for="customer in uniqueCustomers" :key="customer" :value="customer">
                {{ customer }}
              </option>
            </select>
          </label>
          <button v-if="customerFilter" @click="customerFilter = ''" class="clear-filter-btn">
            Clear Filter
          </button>
        </div>
      </div>

      <!-- Floating Action Bar for Multi-Select -->
      <div v-if="multiSelectMode && selectedInventoryIds.length > 0 && !multiMoveMode" class="multi-select-action-bar">
        <div class="selection-info">
          <strong>{{ selectedInventoryIds.length }}</strong> items selected
        </div>
        <div class="action-buttons">
          <button @click="startMultiMove" class="move-btn">Move Selected</button>
          <button @click="stageSelectedItems" class="stage-btn">Stage for Customer</button>
          <button @click="unstageSelectedItems" class="unstage-btn">Unstage</button>
          <button @click="showDispatchModal" class="dispatch-btn">üì§ Dispatch</button>
          <button @click="clearMultiSelect" class="ghost">Cancel</button>
        </div>
      </div>

      <!-- Multi-Move Destination Selection Bar -->
      <div v-if="multiMoveMode" class="multi-select-action-bar multi-move-bar">
        <div class="selection-info">
          Select destinations: <strong>{{ multiMoveDestinations.length }}</strong> of <strong>{{ selectedInventoryIds.length }}</strong>
        </div>
        <div class="action-buttons">
          <button 
            @click="confirmMultiMove" 
            class="move-btn"
            :disabled="multiMoveDestinations.length !== selectedInventoryIds.length"
          >
            Confirm Move
          </button>
          <button @click="cancelMultiMove" class="ghost">Cancel</button>
        </div>
      </div>

      <div class="zones-container" aria-label="Warehouse zones">
        <div v-for="zone in zones" :key="zone" class="zone-section">
          <div class="zone-header">
            <h3 class="zone-title">{{ zone }}</h3>
            <span class="zone-count">{{ zoneLocationCounts[zone] }} locations</span>
          </div>

          <div class="warehouse" :data-zone="zone">
            <div v-for="row in rowsByZone[zone]" :key="`${zone}-${row.row}`" class="warehouse-row">
              <div class="row-label">Row {{ row.row }}</div>

              <div class="row-cells">
                <div
                  v-for="cell in row.cells"
                  :key="`${zone}-${cell.row}-${cell.col}`"
                  class="stack"
                >
                  <!-- T -->
                  <div
                    class="tier"
                    v-if="cell.tiers.T"
                    :class="{
                      occupied: isOccupied(cell.tiers.T.id),
                      selected: selectedLocationId === cell.tiers.T.id,
                      destination: selectedDestinationId === cell.tiers.T.id,
                      source: selectedSourceLocationId === cell.tiers.T.id,
                      'search-hit': isSearchHit(cell.tiers.T.id),
                      staged: inventoryAt(cell.tiers.T.id) && inventoryAt(cell.tiers.T.id).staged,
                      checked: inventoryAt(cell.tiers.T.id) && isInventorySelected(inventoryAt(cell.tiers.T.id).id),
                      'multi-move-dest': isMultiMoveDestination(cell.tiers.T.id)
                    }"
                    @click="onTierTap(cell.tiers.T)"
                  >
                    <div v-if="isMultiMoveDestination(cell.tiers.T.id)" class="dest-number">
                      {{ getMultiMoveDestinationNumber(cell.tiers.T.id) }}
                    </div>
                    <input
                      v-if="multiSelectMode && !multiMoveMode && inventoryAt(cell.tiers.T.id)"
                      type="checkbox"
                      :checked="isInventorySelected(inventoryAt(cell.tiers.T.id).id)"
                      @click.stop="toggleInventorySelection(inventoryAt(cell.tiers.T.id).id)"
                      class="tier-checkbox"
                    />
                    <template v-if="inventoryAt(cell.tiers.T.id)">
                      <div v-if="inventoryAt(cell.tiers.T.id).staged" class="customer-badge">
                        {{ inventoryAt(cell.tiers.T.id).owner }}
                      </div>
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.T.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.T.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.T.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.T.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                  <!-- M -->
                  <div
                    class="tier"
                    v-if="cell.tiers.M"
                    :class="{
                      occupied: isOccupied(cell.tiers.M.id),
                      selected: selectedLocationId === cell.tiers.M.id,
                      destination: selectedDestinationId === cell.tiers.M.id,
                      source: selectedSourceLocationId === cell.tiers.M.id,
                      'search-hit': isSearchHit(cell.tiers.M.id),
                      staged: inventoryAt(cell.tiers.M.id) && inventoryAt(cell.tiers.M.id).staged,
                      checked: inventoryAt(cell.tiers.M.id) && isInventorySelected(inventoryAt(cell.tiers.M.id).id),
                      'multi-move-dest': isMultiMoveDestination(cell.tiers.M.id)
                    }"
                    @click="onTierTap(cell.tiers.M)"
                  >
                    <div v-if="isMultiMoveDestination(cell.tiers.M.id)" class="dest-number">
                      {{ getMultiMoveDestinationNumber(cell.tiers.M.id) }}
                    </div>
                    <input
                      v-if="multiSelectMode && !multiMoveMode && inventoryAt(cell.tiers.M.id)"
                      type="checkbox"
                      :checked="isInventorySelected(inventoryAt(cell.tiers.M.id).id)"
                      @click.stop="toggleInventorySelection(inventoryAt(cell.tiers.M.id).id)"
                      class="tier-checkbox"
                    />
                    <template v-if="inventoryAt(cell.tiers.M.id)">
                      <div v-if="inventoryAt(cell.tiers.M.id).staged" class="customer-badge">
                        {{ inventoryAt(cell.tiers.M.id).owner }}
                      </div>
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.M.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.M.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.M.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.M.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                  <!-- B -->
                  <div
                    class="tier"
                    v-if="cell.tiers.B"
                    :class="{
                      occupied: isOccupied(cell.tiers.B.id),
                      selected: selectedLocationId === cell.tiers.B.id,
                      destination: selectedDestinationId === cell.tiers.B.id,
                      source: selectedSourceLocationId === cell.tiers.B.id,
                      'search-hit': isSearchHit(cell.tiers.B.id),
                      staged: inventoryAt(cell.tiers.B.id) && inventoryAt(cell.tiers.B.id).staged,
                      checked: inventoryAt(cell.tiers.B.id) && isInventorySelected(inventoryAt(cell.tiers.B.id).id),
                      'multi-move-dest': isMultiMoveDestination(cell.tiers.B.id)
                    }"
                    @click="onTierTap(cell.tiers.B)"
                  >
                    <div v-if="isMultiMoveDestination(cell.tiers.B.id)" class="dest-number">
                      {{ getMultiMoveDestinationNumber(cell.tiers.B.id) }}
                    </div>
                    <input
                      v-if="multiSelectMode && !multiMoveMode && inventoryAt(cell.tiers.B.id)"
                      type="checkbox"
                      :checked="isInventorySelected(inventoryAt(cell.tiers.B.id).id)"
                      @click.stop="toggleInventorySelection(inventoryAt(cell.tiers.B.id).id)"
                      class="tier-checkbox"
                    />
                    <template v-if="inventoryAt(cell.tiers.B.id)">
                      <div v-if="inventoryAt(cell.tiers.B.id).staged" class="customer-badge">
                        {{ inventoryAt(cell.tiers.B.id).owner }}
                      </div>
                      <div class="product-code">
                        {{ inventoryAt(cell.tiers.B.id).product_code }}
                      </div>
                      <div class="item-line">Lot: {{ inventoryAt(cell.tiers.B.id).lot || 'N/A' }}</div>
                      <div class="item-line">Size: {{ inventoryAt(cell.tiers.B.id).seed_size || 'N/A' }}</div>
                      <div class="item-line">Pkg: {{ inventoryAt(cell.tiers.B.id).package_type || 'N/A' }}</div>
                    </template>
                    <template v-else>
                      <div class="empty">Empty</div>
                    </template>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

  </div>

  <!-- Dispatch Modal (inside Vue app) -->
  <div v-if="dispatchModal.show" class="scanner-modal">
    <div class="scanner-overlay" @click="closeDispatchModal"></div>
    <div class="scanner-container">
      <div class="scanner-header">
        <h3>Dispatch Items</h3>
        <button @click="closeDispatchModal" class="close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="scanner-footer" style="padding: 20px;">
        <p style="margin-bottom: 12px;">You are about to dispatch <strong>{{ selectedInventoryIds.length }}</strong> item(s). This will remove them from inventory and create a log entry.</p>
        <label style="display: block; margin-bottom: 16px;">
          <strong>Notes (optional)</strong>
          <textarea 
            v-model="dispatchModal.notes" 
            placeholder="e.g., Sent to farm, Transferred to branch B, etc."
            rows="3"
            style="width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #dfe3eb; border-radius: 6px; font-family: inherit; resize: vertical;"
          ></textarea>
        </label>
        <div class="scanner-buttons">
          <button @click="confirmDispatch" class="dispatch-btn" style="background: #dc2626; color: white;">Confirm Dispatch</button>
          <button @click="closeDispatchModal" class="ghost">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Camera Scanner Modal -->
<div id="camera-scanner-modal" class="scanner-modal" style="display: none;">
  <div class="scanner-overlay" onclick="closeCameraScanner()"></div>
  <div class="scanner-container">
    <div class="scanner-header">
      <h3>Scan Barcode</h3>
      <button onclick="closeCameraScanner()" class="close-btn" aria-label="Close scanner">‚úï</button>
    </div>
    <div id="qr-reader" class="scanner-video"></div>
    <div class="scanner-footer">
      <p id="scanner-status" class="scanner-status">Position barcode within frame</p>
      <div class="scanner-buttons">
        <button onclick="switchToFileUpload()" class="secondary-btn">üì∑ Take Photo Instead</button>
        <button onclick="closeCameraScanner()" class="ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="/js/barcode-utils.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="/js/scanner.js"></script>
<script src="/js/map.js"></script>

</body>
</html>
